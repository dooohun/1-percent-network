# Story3. 전 세계의 DNS 서버가 연대한다.

DNS는 전 세계의 IP 주소에 대응하는 도메인을 효율적으로 관리하기 위해 개발된 시스템이다. 그렇다면 DNS 서버가 어떻게 동작을 하는지 알아보도록 하자.

## DNS 서버의 기본 동작

DNS 서버는 클라이언트에서 조회 메시지를 받고 조회내용에 응답하는 형태로 정보를 회답한다. 조회 메시지에는 이름, 클래스, 타입 총 세 가지 정보가 포함되어 있다. 이름은 서버의 이름을 뜻하고, 클래스는 인터넷을 나타내는 ‘IN’이라는 값으로 표현된다. 마지막으로 타입은 어떤 타입의 정보가 지원되는지를 나타낸다.
 
(타입의 종류)
| 타입 종류 | 내용   |
|-----|----|
|     A    |  도메인 주소를 IP 주소(IPv4)로 매핑   |
|   AAAA   |  도메인 주소를 IP 주소(IPv6)로 매핑   |
|    MX    |  도메인에 대한 메일 서버 정보         |
|   CNAME  |  도메인 주소에 대한 별칭              |
|    SOA   |  본 영역에 대한 권한                 |
|    NS    |  본 영역에 대한 네임 서버             |
|    TXT   |  도메인에 대한 일반 텍스트            |

이렇게 DNS 서버는 등록된 정보를 찾아 세 가지와 일치하는 것을 찾는다. 모두 일치한다면 IP 주소를 반환한다.

## 도메인 계층

도메인의 체계적인 분류와 관리를 위해 도메인 이름은 몇 개의 짧은 영문자를 점(.)으로 구분한 계층 구조를 갖고 있다. 각 단계 별로 도메인이 나뉜다. 

루트 도메인은 DNS 계층 구조의 가장 위에 위치한 도메인이다. 국가를 나타내는 국가 코드 도메인, 일반 도메인을 1단계 도메인이라고 한다. 1단계 도메인의 하위 도메인인 2단계 도메인에는 조직의 속성을 구분하는 co, go, ac와 같은 도메인이 있다. 3단계 도메인은 조직이나 서비스의 이름을 나타내는 도메인 이름으로 도메인 사용자가 원하는 문자열을 사용할 수 있다. 마지막은 서버의 이름을 나타내는 호스트가 위치한다.
![도메인 계층구조](https://velog.velcdn.com/images/ehgns0305/post/411372d2-8337-4b8a-8f13-be2657c0c01e/image.png)

(예시)

www.naver.com  
www – 호스트, naver - 3단계 도메인, com – 1단계 도메인(일반 도메인)
www.snu.ac.kr  
www – 호스트, snu - 3단계 도메인, ac – 2단계 도메인(대학), kr – 국가 코드 도메인

## DNS 서버 과정

도메인은 도메인 계층 구조를 반영한 DNS 서버에 저장, 관리된다. 상위 계층의 DNS 서버는 하위 계층의 도메인에 대한 정보를 관리하고 하위 계층 DNS 서버의 IP 주소를 갖고 있다. 최상위 계층인 루트 도메인은 com, kr 등의 DNS 서버를 등록하여 갖고 있다.

이런 준비 과정을 통해 IP 주소를 찾을 수 있다. DNS 서버는 도메인 계층을 따라서 질의 과정을 반복하며 찾고자 하는 도메인의 IP 주소를 찾는다. 예시를 통해 더 자세히 알아보자.

사용자가 www.naver.com을 입력하면 사용자의 컴퓨터는 로컬 DNS 캐시에서 해당 정보를 찾아보고, 없다면 가까운 DNS 서버에 도메인 이름의 IP 주소를 질의한다.  
가까운 DNS 서버는 루트 도메인 서버의 IP 주소를 알고 있어, 이를 통해 1단계 도메인 서버를 찾아가야 한다는 정보를 제공한다.  
루트 도메인 DNS 서버가 알려준 1단계 도메인 DNS 서버의 IP 주소로 질의를 해서 2단계 도메인 DNS 서버의 IP 주소를 얻는다.  
마지막으로 2단계 도메인 DNS 서버는 3단계 도메인 DNS 서버에 질의해서 www.naver.com IP 주소를 얻어 사용자의 컴퓨터에 네이버의 IP 주소를 알려준다.

![DNS 동작](https://velog.velcdn.com/images/ehgns0305/post/d4308d23-90e9-496b-bcb2-ccd115a629c3/image.png)  
DNS 서버들의 조회 동작

## DNS 캐시
DNS 캐시는 이전에 해결한 도메인 이름에 대한 결과를 저장해두는 임시 저장소이다. 이렇게 저장해둔 정보는 추후 동일한 도메인 이름에 대한 질의 시 다시 DNS 서버에 질의하지 않고 바로 결과를 가져올 수 있게 해준다.  
이는 자주 사용되는 도메인 이름에 대한 조회 과정을 빠르게 만들어주는 중요한 역할을 한다.

# Story 4. 프로토콜 스택에 메시지 송신을 의뢰한다.
## 프로토콜 스택
프로토콜 스택(protocol stack)은 계층화된 구조(layered architecture)로 모여 있는 프로토콜들의 집합을 말한다. 계층을 나누는 목적은 매우 복잡한 네트워크에서 프로토콜들의 역할을 분담하기 위해서이다. 
![프로토콜 스택](https://velog.velcdn.com/images/ehgns0305/post/f91552ed-183c-4d6b-af01-6faf6326cf3c/image.png)  
프로토콜 스택 구조
 
데이터가 실제로 전달되기 위해서는 OS 내부의 네트워크 제어용 소프트웨어와 네트워크용 하드웨어가 브라우저에서 받은 메시지를 서버에 송출해야 한다. 이를 위해 브라우저는 프로토콜 스택에 미시지 송신을 의뢰하는데, 이는 Socket 라이브러리 프로그램을 통해 가능하다.  

Socket 라이브러리를 이용한 데이터 송/수신은 컴퓨터 사이에 데이터의 통로 같은 것이 있고, 이것을 통해 데이터가 흐르면서 상대 측에 도착한다. 데이터는 양방향으로 흐를 수 있다.

그림 1-17) 파이프와 같은 것을 통해 데이터가 흐른다.

# 데이터 송/수신 단계
데이터 송/수신 단계는 총 4단계로 이루어져 있다. 그 내용은 다음과 같다. 

1\)	소켓 작성 단계  
2\)	접속 단계  
3\)	송/수신 단계  
4\)	연결 끊기 단계  

데이터 송/수신 단계에 대해 더 자세히 알아보도록 하자.
1.	소켓 작성 단계  
데이터 송/수신 동작을 하기 전 클라이언트 측과 서버 측을 파이프로 연결하는 동작이 필요하다. 그렇기 위해서는 파이프 양 끝에서 출입구 역할을 하는 소켓이 필요하다.  
Socket 라이브러리의 socket 이라는 프로그램 부품을 호출하면 프로토콜 스택에서는 의뢰에 따라 하나의 소켓을 만든다. 소켓을 나타내는 디스크립터(일종의 번호표 같은 것으로, 소켓을 식별한다.)를 브라우저에 전달한다. 

2.	접속 단계  
int connect(int socket, const struct sockaddr *address, socklen_t address_len)  
소켓을 서버 측의 소켓에 접속하도록 프로토콜 스택에 의뢰하는 과정이 필요하다. Socket 라이브러리의 connect를 호출하여 이 의뢰 동작을 실행한다. 이때 디스크립터, 서버의 IP 주소, 포트 번호 정보를 프로토콜 스택에 전달한다.  
디스크립터는 애플리케이션이 소켓을 식별할 때 사용한다. IP 주소와 *포트 번호는 클라이언트와 서버 사이에 상대의 소켓을 식별할 때 사용된다.  
(*포트 번호의 규칙은 전 세계적으로 통일되어 있고 IP 주소와 같이 다른 것과 중복되지 않도록 일괄 관리하고 있다. 널리 알려진 포트 번호에는 21(FTP), 25번(SMTP), 80번(http) 등이 있다.)

3.	송/수신 단계  
송신  
ssize_t send(int socket, const void *buffer, size_t length, int flags)  
소켓을 통해 데이터를 전송하는데 사용된다. HTTP에서는 요청 메시지가 데이터에 해당된다.  
수신  
ssize_t read(int fs, void *buf, size_t N)  
소켓에서 데이터를 읽어오는 데 사용된다. HTTP에서는 응답 메시지가 데이터에 해당된다.

4.	연결 끊기 단계  
int close(int socket)  
애플리케이션이 송신해야 하는 데이터를 전부 송신했다고 판단하면 서버에서 연결을 끊어 소켓을 말소시킨다. Close 함수를 호출하여 데이터 송/수신 동작을 끝낸다.


참조

**DNS 서버** - https://better-together.tistory.com/128

**프로토콜 스택** - https://blog.naver.com/netrance/110112688107

**소켓 프로그래밍 함수**

connect https://www.ibm.com/docs/en/zos/2.2.0?topic=functions-connect-connect-socket

read https://www.ibm.com/docs/en/zos/2.1.0?topic=functions-read-read-from-file-socket

send https://www.ibm.com/docs/en/zos/2.1.0?topic=functions-send-send-data-socket

close https://www.ibm.com/docs/en/zvse/6.2?topic=SSB27H_6.2.0/fa2ti_call_close.html
